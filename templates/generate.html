<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Generation – DreamLayout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #6d28d9;
            --accent: #f472b6;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .dark .glass-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .step-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.6s ease-out forwards;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .select-wrapper::after {
            content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7' /%3E%3C/svg%3E");
            width: 14px;
            height: 14px;
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .select-wrapper:focus-within::after {
            transform: translateY(-50%) rotate(180deg);
            content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238b5cf6' stroke-width='3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7' /%3E%3C/svg%3E");
        }

        .dark select option {
            background: #0f172a;
            color: #f1f5f9;
        }

        /* Custom Dropdown Styling */
        .custom-select-container {
            position: relative;
            width: 100%;
        }

        .custom-select-trigger {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .custom-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            padding: 8px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .custom-options {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }

        .custom-select-container.open .custom-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-option {
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .custom-option:hover {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .custom-option.selected {
            background: #8b5cf6;
            color: white !important;
        }

        /* Custom Toast Notification */
        #custom-toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            z-index: 1000;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }

        #custom-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 14px 28px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #1e293b;
        }

        .dark .toast-content {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            color: #f1f5f9;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            font-weight: 700;
            font-size: 14px;
            letter-spacing: -0.01em;
        }
    </style>
    <script>
            (function () {
                const saved = localStorage.getItem('theme') || 'system';
                const html = document.documentElement;
                const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
                if (saved === 'dark' || (saved === 'system' && darkQuery.matches)) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            })();
    </script>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen transition-all duration-300 overflow-x-hidden">

    <!-- ================= NAVBAR ================= -->
    <nav class="fixed top-0 left-0 w-full z-50 px-6 py-4">
        <div
            class="max-w-7xl mx-auto glass border border-white/40 rounded-full px-6 py-3 flex items-center justify-between shadow-xl shadow-slate-200/40">

            <a href="/dashboard" class="flex items-center gap-3 group">
                <img src="/static/logo.png" alt="DreamLayout"
                    class="h-10 w-auto group-hover:scale-110 transition dark:brightness-110">
                <span
                    class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-violet-700 to-indigo-700 dark:from-violet-400 dark:to-indigo-400">DreamLayout</span>
            </a>

            <div class="flex items-center space-x-4">
                <div id="step-indicator"
                    class="flex items-center gap-2 md:gap-4 mr-2 md:mr-4 border-r border-slate-200 dark:border-slate-800 pr-4 md:pr-6">
                    <div
                        class="hidden xs:block h-2 w-8 md:w-12 rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-violet-600 transition-all duration-500"
                            style="width: 33.3%"></div>
                    </div>
                    <span class="text-[9px] md:text-[10px] font-black uppercase text-slate-400 whitespace-nowrap"><span
                            class="hidden md:inline">Phase</span> <span id="current-phase">1</span>/3</span>
                </div>

                <!-- Mobile Menu Toggle -->
                <button id="mobile-menu-btn"
                    class="md:hidden p-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path id="menu-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <!-- Profile + Dropdown (Desktop) -->
                <div id="profile-menu-wrapper" class="hidden md:block relative group">
                    <button id="profile-toggle"
                        class="flex items-center gap-3 focus:outline-none pl-2 pr-1 py-1 rounded-full border border-white dark:border-slate-800 bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-800 hover:shadow-md transition-all">
                        <div
                            class="hidden md:block text-right text-[10px] font-black uppercase text-slate-400 tracking-tighter mr-1">
                            {{ current_user.name.split(' ')[0] }}
                        </div>
                        <div
                            class="w-9 h-9 bg-gradient-to-br from-violet-500 to-fuchsia-600 rounded-full flex items-center justify-center text-white font-bold shadow-sm overflow-hidden shrink-0">
                            {% if current_user.profile_pic %}
                            <img src="{{ (current_user.profile_pic if 'http' in current_user.profile_pic else '/static/' + current_user.profile_pic) + '?v=' + current_user.user_key[:8] }}"
                                alt="Profile" class="w-full h-full object-cover">
                            {% else %}
                            {{ current_user.name[0].upper() }}
                            {% endif %}
                        </div>
                        <i class="bi bi-chevron-down text-[10px] text-slate-400 ml-1"></i>
                    </button>

                    <!-- Dropdown menu -->
                    <div id="profile-dropdown"
                        class="hidden absolute right-0 mt-4 w-64 bg-white dark:bg-slate-950 backdrop-blur-2xl rounded-[2rem] shadow-2xl border border-white/50 dark:border-slate-800 p-3 z-50 animate-fade-in-up">
                        <div class="px-4 py-3 border-b border-slate-100 dark:border-slate-800 mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Account</p>
                            <p class="text-sm font-bold text-slate-900 dark:text-slate-200 truncate">{{
                                current_user.email }}</p>
                        </div>

                        <!-- Theme Toggle Section -->
                        <div class="px-2 mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2 px-2">
                                Appearance</p>
                            <div class="grid grid-cols-3 gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-2xl">
                                <button onclick="setTheme('light')"
                                    class="theme-btn light flex flex-col items-center justify-center py-2 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700">
                                    <i class="bi bi-sun-fill text-sm"></i>
                                    <span class="text-[9px] font-bold mt-1">Light</span>
                                </button>
                                <button onclick="setTheme('dark')"
                                    class="theme-btn dark flex flex-col items-center justify-center py-2 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700">
                                    <i class="bi bi-moon-stars-fill text-sm"></i>
                                    <span class="text-[9px] font-bold mt-1">Dark</span>
                                </button>
                                <button onclick="setTheme('system')"
                                    class="theme-btn system flex flex-col items-center justify-center py-2 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700">
                                    <i class="bi bi-display text-sm"></i>
                                    <span class="text-[9px] font-bold mt-1">Auto</span>
                                </button>
                            </div>
                        </div>

                        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2 mx-4"></div>

                        <a href="/profile"
                            class="flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-violet-50 dark:hover:bg-violet-900/30 text-slate-600 dark:text-slate-400 hover:text-violet-700 dark:hover:text-violet-400 transition font-bold text-sm">
                            <span
                                class="bg-violet-100 dark:bg-violet-900/50 text-violet-600 dark:text-violet-400 p-2 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-person-fill"></i></span>
                            My Profile
                        </a>
                        <a href="/logout"
                            class="flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-red-50 dark:hover:bg-red-900/30 text-red-500 transition font-bold text-sm">
                            <span
                                class="bg-red-100 dark:bg-red-900/50 text-red-500 dark:text-red-400 p-2 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-power"></i></span>
                            Log out
                        </a>
                    </div>
                </div>

                <!-- Mobile Menu Overlay -->
                <div id="mobile-menu"
                    class="hidden md:hidden absolute top-24 left-6 right-6 bg-white dark:bg-slate-950 backdrop-blur-2xl border border-white/50 dark:border-slate-800 rounded-[2rem] p-6 shadow-2xl animate-fade-in-up z-50">
                    <nav class="flex flex-col space-y-2">
                        <a href="/dashboard"
                            class="flex items-center gap-3 px-5 py-4 rounded-2xl hover:bg-violet-50 dark:hover:bg-violet-900/30 text-slate-600 dark:text-slate-400 hover:text-violet-700 dark:hover:text-violet-400 border border-transparent transition font-bold">
                            <span
                                class="p-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-grid-1x2-fill"></i></span> Dashboard
                        </a>
                        <a href="/templates"
                            class="flex items-center gap-3 px-5 py-4 rounded-2xl hover:bg-violet-50 dark:hover:bg-violet-900/30 text-slate-600 dark:text-slate-400 hover:text-violet-700 dark:hover:text-violet-400 border border-transparent transition font-bold">
                            <span
                                class="p-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-layout-text-window-reverse"></i></span> Templates
                        </a>
                        <a href="/settings"
                            class="flex items-center gap-3 px-5 py-4 rounded-2xl hover:bg-violet-50 dark:hover:bg-violet-900/30 text-slate-600 dark:text-slate-400 hover:text-violet-700 dark:hover:text-violet-400 border border-transparent transition font-bold">
                            <span
                                class="p-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-gear-fill"></i></span> Settings
                        </a>
                        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2"></div>
                        <a href="/profile"
                            class="flex items-center gap-3 px-5 py-4 rounded-2xl hover:bg-violet-50 dark:hover:bg-violet-900/30 text-slate-600 dark:text-slate-400 hover:text-violet-700 dark:hover:text-violet-400 border border-transparent transition font-bold">
                            <span
                                class="p-2 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-person-fill"></i></span> Profile
                        </a>

                        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2"></div>

                        <!-- Theme Toggle (Mobile) -->
                        <div class="px-5 py-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Appearance
                            </p>
                            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-2xl w-full">
                                <button onclick="setTheme('light')"
                                    class="theme-btn light flex-1 flex items-center justify-center gap-2 py-3 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700">
                                    <i class="bi bi-sun-fill text-sm"></i>
                                    <span class="text-xs font-bold">Light</span>
                                </button>
                                <button onclick="setTheme('dark')"
                                    class="theme-btn dark flex-1 flex items-center justify-center gap-2 py-3 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700">
                                    <i class="bi bi-moon-stars-fill text-sm"></i>
                                    <span class="text-xs font-bold">Dark</span>
                                </button>
                            </div>
                        </div>

                        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2"></div>

                        <a href="/logout"
                            class="flex items-center gap-3 px-5 py-4 rounded-2xl hover:bg-red-50 dark:hover:bg-red-900/30 text-red-500 transition font-bold">
                            <span
                                class="p-2 bg-red-100 dark:bg-red-900/50 rounded-xl text-xs flex items-center justify-center w-8 h-8"><i
                                    class="bi bi-power"></i></span> Log Out
                        </a>
                    </nav>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-28 pb-20 flex flex-col items-center relative">

        <!-- Background Accents -->
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-violet-500/10 blur-[120px] rounded-full"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-500/10 blur-[120px] rounded-full">
        </div>

        <!-- Multi-Step Container -->
        <div id="survey-container" class="w-full max-w-4xl relative z-10 px-4 md:px-0 mt-8">

            <!-- Step 1: Base Info -->
            <div id="step-1" class="step-transition">
                <div class="flex flex-col items-center mb-12">

                    <div
                        class="flex items-center gap-2 text-slate-400 font-bold text-sm tracking-widest uppercase mb-4 animate-fade-in-up">
                        <span class="text-violet-600">Step 1</span>
                        <span class="mx-2">❯</span>
                        <span>Foundation</span>
                    </div>
                </div>

                <div class="max-w-2xl mx-auto">
                    <div class="space-y-10">
                        <!-- Venture Type -->
                        <div class="space-y-4">
                            <label class="block text-base font-bold text-slate-700 dark:text-slate-300 px-1">Venture
                                Type</label>
                            <div class="relative group select-wrapper custom-select-container"
                                data-select-id="venture_type">
                                <select id="venture_type" onchange="checkOtherVenture(this)" class="hidden">
                                    <option value="Residential">1. Residential</option>
                                    <option value="Office / Corporate">2. Office / Corporate</option>
                                    <option value="Commercial">3. Commercial</option>
                                    <option value="Healthcare">4. Healthcare</option>
                                    <option value="Hospitality">5. Hospitality</option>
                                    <option value="Industrial / Storage">6. Industrial / Storage</option>
                                    <option value="Educational">7. Educational</option>
                                    <option value="Public / Government">8. Public / Government</option>
                                    <option value="Modern / Tech-Driven">9. Modern / Tech-Driven</option>
                                    <option value="Other">10. Other</option>
                                </select>
                                <div
                                    class="custom-select-trigger w-full px-8 py-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all text-lg font-medium">
                                    <span class="selected-value">1. Residential</span>
                                </div>
                                <div class="custom-options"></div>
                            </div>
                            <div id="other_venture_container" class="hidden mt-4 animate-fade-in">
                                <input type="text" id="other_venture" placeholder="Enter custom venture type..."
                                    class="w-full px-8 py-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all">
                            </div>
                        </div>

                        <!-- Available Area & Floors -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <label
                                    class="block text-base font-bold text-slate-700 dark:text-slate-300 px-1">Available
                                    Area</label>
                                <div class="flex gap-4">
                                    <div class="flex-1 relative">
                                        <input type="number" id="area" placeholder="e.g. 1500"
                                            class="w-full px-8 py-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all text-lg font-medium">
                                    </div>
                                    <div class="w-32 relative group select-wrapper custom-select-container"
                                        data-select-id="area_units">
                                        <select id="area_units" class="hidden">
                                            <option value="Sq Ft">Sq Ft</option>
                                            <option value="Sq Yards">Sq Yards</option>
                                            <option value="Acres">Acres</option>
                                        </select>
                                        <div
                                            class="custom-select-trigger w-full px-6 py-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all text-lg font-medium">
                                            <span class="selected-value">Sq Ft</span>
                                        </div>
                                        <div class="custom-options"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <label class="block text-base font-bold text-slate-700 dark:text-slate-300 px-1">Number
                                    of Floors</label>
                                <div class="relative group select-wrapper custom-select-container"
                                    data-select-id="num_floors">
                                    <select id="num_floors" class="hidden">
                                        <option value="1">Single Floor (Ground)</option>
                                        <option value="2">2 Floors (Ground + 1)</option>
                                        <option value="3">3 Floors (Ground + 2)</option>
                                        <option value="4">4 Floors (Ground + 3)</option>
                                        <option value="Other">Custom / Many</option>
                                    </select>
                                    <div
                                        class="custom-select-trigger w-full px-8 py-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all text-lg font-medium">
                                        <span class="selected-value">Single Floor (Ground)</span>
                                    </div>
                                    <div class="custom-options"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 flex justify-center">
                    <button onclick="nextStep(2)"
                        class="group flex items-center gap-3 px-12 py-6 rounded-full bg-gradient-to-r from-violet-600 to-indigo-700 text-white font-black hover:scale-105 hover:shadow-[0_20px_50px_rgba(139,92,246,0.3)] transition-all duration-300 shadow-xl shadow-violet-600/20">
                        <span>Continue to Sketch</span>
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 group-hover:translate-x-1 transition-transform" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="step-2" class="hidden step-transition w-full max-w-4xl mx-auto">
                <div class="flex flex-col items-center mb-12">
                    <div
                        class="flex items-center gap-2 text-slate-400 font-bold text-sm tracking-widest uppercase mb-4 animate-fade-in-up">
                        <span class="text-slate-400">Step 1</span>
                        <span class="mx-2">❯</span>
                        <span class="text-violet-600">Step 2</span>
                        <span class="mx-2">❯</span>
                        <span>Outline</span>
                    </div>
                </div>

                <div class="mb-10 text-center animate-fade-in-up">
                    <h2 class="text-4xl font-black text-slate-900 dark:text-white tracking-tight mb-3">Refine Site
                        Outline</h2>
                    <p class="text-slate-500 text-sm font-medium max-w-md mx-auto">Draw the perimeter precisely. Our AI
                        will transform this into structured architectural walls.</p>
                </div>

                <div class="grid grid-cols-1 gap-10 items-start">
                    <!-- Workspace -->
                    <div class="space-y-6">
                        <div class="relative group mx-auto">
                            <canvas id="sketch-canvas" width="800" height="500"
                                class="w-full h-auto bg-white dark:bg-slate-950 rounded-[2.5rem] cursor-crosshair border border-slate-200 dark:border-slate-800 shadow-xl hover:border-violet-500/30 transition-all duration-500 mx-auto"></canvas>

                            <!-- Architectural Directions (Canvas Edges) -->
                            <div
                                class="absolute top-6 left-1/2 -translate-x-1/2 px-4 py-1.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border border-slate-100 dark:border-slate-700/50 rounded-full text-[10px] font-black text-slate-400 uppercase tracking-widest pointer-events-none shadow-sm transition-all group-hover:scale-110">
                                North</div>
                            <div
                                class="absolute bottom-6 left-1/2 -translate-x-1/2 px-4 py-1.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border border-slate-100 dark:border-slate-700/50 rounded-full text-[10px] font-black text-slate-400 uppercase tracking-widest pointer-events-none shadow-sm transition-all group-hover:scale-110">
                                South</div>
                            <div
                                class="absolute left-6 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border border-slate-100 dark:border-slate-700/50 rounded-full text-[10px] font-black text-slate-400 uppercase tracking-widest pointer-events-none shadow-sm -rotate-90 transition-all group-hover:scale-110">
                                West</div>
                            <div
                                class="absolute right-6 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border border-slate-100 dark:border-slate-700/50 rounded-full text-[10px] font-black text-slate-400 uppercase tracking-widest pointer-events-none shadow-sm rotate-90 transition-all group-hover:scale-110">
                                East</div>

                            <div class="absolute bottom-8 left-8 flex gap-4">
                                <div
                                    class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-5 py-2.5 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 text-[10px] font-black text-slate-500 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-violet-500 animate-pulse"></span>
                                    Draw perimeter
                                </div>
                            </div>
                            <div class="absolute bottom-8 right-8 flex gap-2">
                                <button onclick="clearCanvas()"
                                    class="px-8 py-3 rounded-2xl bg-white dark:bg-slate-900 shadow-2xl border border-slate-100 dark:border-slate-700 text-xs font-black hover:bg-red-50 hover:text-red-500 transition-all transform active:scale-95 group/clear">
                                    <span class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="w-3 h-3 group-hover/clear:rotate-12 transition-transform" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        Clear
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis and Controls -->
                    <div class="max-w-2xl mx-auto w-full space-y-8 animate-fade-in-up" style="animation-delay: 0.1s">
                        <div
                            class="glass p-10 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 space-y-8 shadow-sm">
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-6 text-center">Site
                                    Data & Analysis</label>

                                <div id="no-sketch-hint"
                                    class="flex flex-col items-center justify-center p-10 bg-slate-50 dark:bg-slate-950/40 rounded-[2.5rem] border border-dashed border-slate-200 dark:border-slate-800 text-center">
                                    <div
                                        class="w-20 h-20 bg-white dark:bg-slate-900 rounded-3xl shadow-lg flex items-center justify-center text-4xl mb-6 text-violet-600">
                                        <i class="bi bi-pencil-square"></i>
                                    </div>
                                    <p class="text-sm font-black text-slate-900 dark:text-slate-100">Capture Land
                                        Perimeter</p>
                                    <p class="text-[11px] text-slate-400 mt-2 leading-relaxed">Use the workspace to
                                        draw<br>your site boundaries.</p>
                                </div>

                                <div id="sides-input-container" class="hidden space-y-8 animate-fade-in">
                                    <div id="sides-list"
                                        class="space-y-3 max-h-[250px] overflow-y-auto pr-2 custom-scrollbar">
                                        <!-- Dynamic inputs -->
                                    </div>

                                    <div class="pt-6 border-t border-slate-100 dark:border-slate-800">
                                        <label
                                            class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1">Dimension
                                            Units</label>
                                        <div class="relative group select-wrapper custom-select-container"
                                            data-select-id="dim_units">
                                            <select id="dim_units" class="hidden">
                                                <option value="Feet">Feet</option>
                                                <option value="Meters">Meters</option>
                                            </select>
                                            <div
                                                class="custom-select-trigger w-full px-6 py-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950/50 font-bold text-sm flex items-center justify-between">
                                                <span class="selected-value">Feet</span>
                                            </div>
                                            <div class="custom-options"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="space-y-6 pt-10 border-t border-slate-50 dark:border-slate-800/50 flex flex-col items-center">
                                <button onclick="nextStep(3)"
                                    class="w-full group flex items-center justify-between px-8 py-6 rounded-2xl bg-gradient-to-r from-violet-600 to-indigo-700 text-white font-black hover:scale-[1.02] shadow-xl shadow-violet-600/20 transition-all">
                                    <span class="text-lg">Continue to Details</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                    </svg>
                                </button>


                                <button onclick="nextStep(1)"
                                    class="w-full px-10 py-6 rounded-[2rem] bg-slate-100 dark:bg-slate-800 font-bold text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                                    </svg>
                                    Back to Foundation
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Step 3: Prompting -->
            <div id="step-3" class="hidden step-transition">
                <div class="flex flex-col items-center mb-12">

                    <div
                        class="flex items-center gap-2 text-slate-400 font-bold text-sm tracking-widest uppercase mb-4 animate-fade-in-up">
                        <span>Step 1</span>
                        <span class="mx-2">❯</span>
                        <span>Step 2</span>
                        <span class="mx-2">❯</span>
                        <span class="text-violet-600">Step 3</span>
                    </div>
                </div>

                <div class="max-w-3xl mx-auto space-y-10">
                    <h1
                        class="text-4xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-b from-slate-900 to-slate-500 dark:from-white dark:to-slate-400">
                        Share your thoughts</h1>

                    <div class="relative">
                        <textarea id="prompt_reqs" rows="8"
                            placeholder="e.g. Modern industrial style with an open floor plan, three private cabins, and a central relaxation zone..."
                            class="w-full px-10 py-10 rounded-[3rem] border border-slate-200 dark:border-slate-800 bg-white/30 dark:bg-slate-900/40 backdrop-blur-xl focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all text-xl custom-scrollbar shadow-inner"></textarea>
                    </div>

                    <div class="flex justify-between items-center">
                        <button onclick="nextStep(2)"
                            class="px-10 py-5 rounded-full bg-slate-100 dark:bg-slate-800 font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">Back</button>

                        <button onclick="startGeneration()"
                            class="group flex items-center gap-3 px-16 py-6 rounded-full bg-gradient-to-r from-violet-600 to-indigo-700 text-white font-black hover:scale-105 hover:shadow-[0_20px_50px_rgba(139,92,246,0.3)] transition-all duration-300 shadow-xl shadow-violet-600/20">
                            <span>Generate</span>
                            <i class="bi bi-lightning-charge-fill animate-pulse text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Loading & Results Screen -->
        <div id="generation-ui"
            class="hidden w-full min-h-screen fixed inset-0 z-[100] bg-slate-50 dark:bg-slate-950 flex flex-col items-center justify-center p-6 overflow-y-auto custom-scrollbar">

            <!-- Loader View -->
            <div id="loader-view" class="flex flex-col items-center justify-center animate-fade-in">
                <div class="w-32 h-32 relative mb-8">
                    <div class="absolute inset-0 border-4 border-violet-100 dark:border-violet-900/30 rounded-full">
                    </div>
                    <div
                        class="absolute inset-0 border-4 border-violet-600 rounded-full border-t-transparent animate-spin">
                    </div>
                    <div <i class="bi bi-magic"></i></div>
                </div>
                <h2 class="text-3xl font-black mb-2 text-slate-900 dark:text-white">Crafting your layout...</h2>
                <p class="text-slate-500 font-medium">Optimizing spatial distribution and architectural flow.</p>
            </div>

            <!-- Result View -->
            <div id="result-view"
                class="hidden w-full max-w-[1600px] min-h-[85vh] grid grid-cols-1 lg:grid-cols-12 gap-8 items-stretch animate-fade-in pb-20">
                <!-- Left: Chat Workspace -->
                <div
                    class="lg:col-span-4 flex flex-col bg-white dark:bg-slate-900 rounded-[3rem] border border-slate-100 dark:border-slate-800 shadow-2xl overflow-hidden">
                    <div
                        class="p-6 border-b border-slate-50 dark:border-slate-800 bg-slate-50/50 dark:bg-black/20 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-violet-600 flex items-center justify-center text-white text-xl">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-black text-slate-900 dark:text-white uppercase tracking-widest">
                                    Architect Assistant</h3>
                                <div class="flex items-center gap-1.5 mt-0.5">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                    <span class="text-[9px] font-black text-slate-400 uppercase">Analysis
                                        Complete</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="toggleChat()"
                            class="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors text-slate-400"
                            title="Close Chat">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div id="chat-messages"
                        class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar bg-slate-50/30 dark:bg-transparent">
                        <!-- AI Message -->
                        <div class="flex gap-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center text-violet-600 text-sm shrink-0 font-bold">
                                A</div>
                            <div class="space-y-4 max-w-[90%]">
                                <div
                                    class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-100 dark:border-slate-700 shadow-sm text-sm text-slate-700 dark:text-slate-300 leading-relaxed font-medium">
                                    Great news! I've successfully crafted your custom <span id="summary-venture-chat"
                                        class="font-bold text-violet-600"></span> layout for a <span
                                        id="summary-area-chat" class="font-bold text-violet-600"></span> space.
                                    Everything has been designed following your requirements!
                                </div>
                                <div class="bg-violet-50 dark:bg-violet-900/20 p-4 rounded-2xl border border-violet-100 dark:border-violet-800/50 text-sm text-violet-700 dark:text-violet-300 italic font-semibold whitespace-pre-wrap leading-relaxed shadow-inner"
                                    id="ai-advice-text">
                                    Analyzing architectural flow...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-white dark:bg-slate-900 border-t border-slate-50 dark:border-slate-800">
                        <div class="relative">
                            <input type="text" id="chat-input" placeholder="Ask for modifications..."
                                class="w-full pl-6 pr-14 py-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 focus:ring-4 focus:ring-violet-500/10 focus:outline-none font-medium text-sm transition-all">
                            <button onclick="sendMessage()"
                                class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-violet-600 text-white rounded-xl flex items-center justify-center hover:bg-violet-700 transition-all shadow-lg shadow-violet-600/20 active:scale-95">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right: Drawing Space -->
                <div class="lg:col-span-8 flex flex-col h-full space-y-4">
                    <div class="flex items-center justify-between px-2">
                        <div class="flex items-center gap-4">
                            <button id="open-chat-btn" onclick="toggleChat()"
                                class="hidden p-3 rounded-xl bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 flex items-center justify-center text-slate-500 hover:text-violet-600 transition-all">
                                <span class="text-xs font-bold uppercase tracking-widest px-2">Show Chat</span>
                            </button>
                            <h4 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Generated
                                Workspace Preview</h4>
                        </div>
                        <div class="flex gap-3">
                            <a href="/dashboard"
                                class="px-6 py-3 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-red-500 transition flex items-center gap-2">
                                <i class="bi bi-arrow-left"></i> Exit Workspace
                            </a>
                            <button onclick="exportPng()"
                                class="px-6 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-[10px] font-black uppercase tracking-widest text-slate-500 hover:bg-slate-200 transition">Export
                                PNG</button>
                            <button id="save-btn-2" onclick="openSaveModal()"
                                class="px-8 py-3 rounded-xl bg-violet-600 text-white text-[10px] font-black uppercase tracking-widest hover:bg-violet-700 transition shadow-lg shadow-violet-600/20">Save
                                Project</button>
                        </div>
                    </div>

                    <div id="legend-container" class="hidden px-2 mb-2">
                        <div
                            class="glass dark:bg-slate-900/50 rounded-2xl p-4 border border-slate-100 dark:border-slate-800">
                            <h5 class="text-[9px] font-black uppercase text-slate-400 mb-3 tracking-widest">Design
                                Legend</h5>
                            <div id="legend-list" class="flex flex-wrap gap-x-6 gap-y-2">
                                <!-- Legend items will be injected here -->
                            </div>
                        </div>
                    </div>

                    <div id="svg-container"
                        class="flex-1 bg-white dark:bg-slate-950 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-inner p-4 md:p-8 flex items-start justify-start overflow-auto custom-scrollbar relative">
                        <div class="min-w-full min-h-full flex items-center justify-center p-8">
                            <!-- SVG will be injected here and will be scrollable if large -->
                            <div id="svg-inner-container" class="max-w-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Save Modal -->
        <div id="save-modal"
            class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 backdrop-blur-md bg-slate-900/20">
            <div
                class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl border border-slate-100 dark:border-slate-800 animate-fade-in-up">
                <div class="flex flex-col items-center text-center space-y-6">
                    <div
                        class="w-20 h-20 bg-violet-100 dark:bg-violet-900/30 rounded-3xl flex items-center justify-center text-4xl">
                        <i class="bi bi-floppy-fill"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-900 dark:text-white">Save Your Vision</h3>
                        <p class="text-slate-500 text-sm font-medium mt-1">Assign a name to your architectural
                            masterpiece.</p>
                    </div>
                    <div class="w-full space-y-4">
                        <input type="text" id="project-name-input" placeholder="e.g. Modern Lakehouse 2024"
                            class="w-full px-8 py-5 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 focus:ring-4 focus:ring-violet-500/10 focus:outline-none font-bold text-center">
                        <div class="flex gap-4">
                            <button onclick="closeSaveModal()"
                                class="flex-1 py-5 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-500 font-black hover:bg-slate-200 transition-all">Cancel</button>
                            <button id="modal-save-confirm-btn" onclick="confirmSave()"
                                class="flex-1 py-5 rounded-2xl bg-violet-600 text-white font-black hover:bg-violet-700 shadow-xl shadow-violet-600/20 transition-all">Save
                                Project</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        let currentStep = 1;
        const canvas = document.getElementById('sketch-canvas');
        const ctx = canvas.getContext('2d');
        let points = [];
        let drawing = false;
        let generatedLayout = null;
        let detectedVertices = [];



        function nextStep(step) {
            const container = document.getElementById('survey-container');
            // Ensure container stays centered and focused across all steps
            container.classList.add('max-w-4xl');
            container.classList.remove('max-w-[1400px]');

            if (currentStep === 1 && step > 1) {
                const area = document.getElementById('area').value;
                const ventureType = document.getElementById('venture_type').value;
                const otherVenture = document.getElementById('other_venture').value;

                if (!area) { showToast('Please specify the total area.'); return; }
                if (ventureType === 'Other' && !otherVenture.trim()) { showToast('Please specify your custom venture type.'); return; }
            }

            // Validate Step 2 (only if NOT skipping)
            if (currentStep === 2 && step > 2) {
                if (detectedVertices.length < 2) { showToast('Please draw the site outline first.'); return; }

                const sideInputs = document.querySelectorAll('.side-input');
                let allFilled = true;
                sideInputs.forEach(input => { if (!input.value) allFilled = false; });
                if (!allFilled) { showToast('Please provide measurements for all sides.'); return; }
            }

            document.getElementById(`step-${currentStep}`).classList.add('hidden');
            document.getElementById(`step-${step}`).classList.remove('hidden');
            currentStep = step;

            // Update progress
            document.getElementById('current-phase').innerText = step;
            document.getElementById('progress-bar').style.width = (step * 33.3) + '%';

            if (step === 2) initCanvas();
        }

        function initCanvas() {
            const isDark = document.documentElement.classList.contains('dark');
            ctx.strokeStyle = isDark ? '#a78bfa' : '#2e1065'; // Darker violet (Violet-950) for light theme visibility
            ctx.lineWidth = 4;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.shadowBlur = 15; // Enhanced glow for the "pencil"
            ctx.shadowColor = isDark ? '#a78bfa' : 'rgba(46, 16, 101, 0.4)';

            drawGrid();

            canvas.onmousedown = (e) => {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                points = [{ x, y }];
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            canvas.onmousemove = (e) => {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                points.push({ x, y });
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            canvas.onmouseup = () => {
                drawing = false;
                detectSides();
            };
        }

        // Ramer-Douglas-Peucker Algorithm for path simplification
        function getSqDist(p1, p2) {
            return (p1.x - p2.x) * (p1.x - p2.x) + (p1.y - p2.y) * (p1.y - p2.y);
        }

        function getSqSegDist(p, p1, p2) {
            let x = p1.x, y = p1.y, dx = p2.x - x, dy = p2.y - y;
            if (dx !== 0 || dy !== 0) {
                let t = ((p.x - x) * dx + (p.y - y) * dy) / (dx * dx + dy * dy);
                if (t > 1) { x = p2.x; y = p2.y; }
                else if (t > 0) { x += dx * t; y += dy * t; }
            }
            dx = p.x - x; dy = p.y - y;
            return dx * dx + dy * dy;
        }

        function simplifyStep(points, first, last, sqTolerance, simplified) {
            let maxSqDist = sqTolerance, index;
            for (let i = first + 1; i < last; i++) {
                let sqDist = getSqSegDist(points[i], points[first], points[last]);
                if (sqDist > maxSqDist) { index = i; maxSqDist = sqDist; }
            }
            if (maxSqDist > sqTolerance) {
                if (index - first > 1) simplifyStep(points, first, index, sqTolerance, simplified);
                simplified.push(points[index]);
                if (last - index > 1) simplifyStep(points, index, last, sqTolerance, simplified);
            }
        }

        function simplifyPath(points, tolerance) {
            if (points.length <= 2) return points;
            let sqTolerance = tolerance !== undefined ? tolerance * tolerance : 1;
            let last = points.length - 1;
            let simplified = [points[0]];
            simplifyStep(points, 0, last, sqTolerance, simplified);
            simplified.push(points[last]);
            return simplified;
        }

        function detectSides() {
            if (points.length < 5) return;

            // If it looks like a long continuous stroke, maybe a circle?
            // We'll keep more points to preserve the curve.
            let toleranceVal = 20;
            if (points.length > 50) {
                toleranceVal = 8;
            }

            detectedVertices = simplifyPath(points, toleranceVal);

            // If the user drew almost back to the start, close the loop
            const pathStart = detectedVertices[0];
            const pathEnd = detectedVertices[detectedVertices.length - 1];
            const dist = Math.sqrt(getSqDist(pathStart, pathEnd));
            if (dist < 50 && detectedVertices.length > 3) {
                detectedVertices[detectedVertices.length - 1] = pathStart;
            }

            updateUIWithSides();
            drawOutline();
        }

        function updateUIWithSides() {
            const container = document.getElementById('sides-input-container');
            const hint = document.getElementById('no-sketch-hint');
            const list = document.getElementById('sides-list');

            if (detectedVertices.length < 2) {
                container.classList.add('hidden');
                hint.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            hint.classList.add('hidden');
            list.innerHTML = '';

            for (let i = 0; i < detectedVertices.length - 1; i++) {
                const div = document.createElement('div');
                div.className = 'space-y-2 group animate-fade-in-up';
                div.style.animationDelay = `${i * 0.05}s`;
                div.innerHTML = `
                    <div class="flex items-center justify-between px-1">
                        <span class="text-[10px] uppercase font-black text-slate-400">Side ${i + 1}</span>
                    </div>
                    <input type="number" step="0.1" data-side="${i}" placeholder="Length..." 
                        onfocus="drawOutline(${i})" onblur="drawOutline(-1)"
                        class="side-input w-full px-6 py-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 focus:outline-none focus:ring-4 focus:ring-violet-500/20 transition-all font-medium">
                `;
                list.appendChild(div);
            }
        }

        function drawOutline(activeSideIndex = -1) {
            drawGrid();

            ctx.beginPath();
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.2;
            points.forEach((p, i) => {
                if (i === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();
            ctx.globalAlpha = 1.0;

            for (let i = 0; i < detectedVertices.length - 1; i++) {
                const p1 = detectedVertices[i];
                const p2 = detectedVertices[i + 1];

                ctx.beginPath();
                ctx.lineWidth = (i === activeSideIndex) ? 8 : 4;
                ctx.strokeStyle = (i === activeSideIndex) ? '#f472b6' : '#8b5cf6';
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();

                const midX = (p1.x + p2.x) / 2;
                const midY = (p1.y + p2.y) / 2;
                ctx.fillStyle = (i === activeSideIndex) ? '#f472b6' : '#8b5cf6';
                ctx.font = 'bold 14px Outfit';
                ctx.fillText(`${i + 1}`, midX + 12, midY - 12);
            }

            detectedVertices.forEach(v => {
                ctx.beginPath();
                ctx.arc(v.x, v.y, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#8b5cf6';
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = document.documentElement.classList.contains('dark') ? '#1e293b' : '#f1f5f9';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 40) {
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
            }
        }

        function clearCanvas() {
            points = [];
            detectedVertices = [];
            updateUIWithSides();
            drawGrid();
        }

        function checkOtherVenture(select) {
            const container = document.getElementById('other_venture_container');
            if (select.value === 'Other') {
                container.classList.remove('hidden');
                container.classList.add('animate-fade-in-up');
            } else {
                container.classList.add('hidden');
            }
        }

        async function startGeneration() {
            let venture = document.getElementById('venture_type').value;
            if (venture === 'Other') {
                venture = document.getElementById('other_venture').value || 'Custom Project';
            }

            const areaValue = document.getElementById('area').value;
            const units = document.getElementById('area_units').value;
            const prompt = document.getElementById('prompt_reqs').value;

            if (!areaValue) { showToast('Please specify the area.'); return; }
            if (!prompt.trim()) { showToast('Please share your architectural requirements.'); return; }

            const fullArea = `${areaValue} ${units}`;

            document.getElementById('survey-container').classList.add('hidden');
            document.getElementById('generation-ui').classList.remove('hidden');
            document.getElementById('step-indicator').classList.add('hidden');

            const vChat = document.getElementById('summary-venture-chat');
            const aChat = document.getElementById('summary-area-chat');
            if (vChat) vChat.innerText = venture;
            if (aChat) aChat.innerText = fullArea;

            const sCanvas = document.getElementById('summary-canvas');
            if (sCanvas) {
                const sCtx = sCanvas.getContext('2d');
                sCtx.strokeStyle = '#8b5cf6';
                sCtx.lineWidth = 2;
                sCtx.beginPath();
                detectedVertices.forEach((p, i) => {
                    const x = (p.x / canvas.width) * sCanvas.width;
                    const y = (p.y / canvas.height) * sCanvas.height;
                    if (i === 0) sCtx.moveTo(x, y); else sCtx.lineTo(x, y);
                });
                sCtx.stroke();
            }

            const sideInputs = document.querySelectorAll('.side-input');
            let sideMeasurements = [];
            let dimUnits = document.getElementById('dim_units').value;

            sideInputs.forEach(input => {
                const val = input.value || 'not specified';
                const sideIdx = parseInt(input.dataset.side) + 1;
                sideMeasurements.push(`Side ${sideIdx}: ${val} ${dimUnits}`);
            });

            const numFloors = document.getElementById('num_floors').value;
            const finalPrompt = prompt + `\n\nREQUIRED FLOORS: ${numFloors}` + (sideMeasurements.length > 0
                ? `\n\nDetailed Side Measurements:\n${sideMeasurements.join('\n')}`
                : '');

            const simplifiedPoints = points.filter((_, i) => i % 5 === 0);
            try {
                const response = await fetch('/api/generate-layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        venture_type: venture,
                        area: fullArea,
                        dimensions: simplifiedPoints,
                        prompt: finalPrompt
                    })
                });
                const data = await response.json();
                if (data.success) {
                    finishGeneration(data.layout);
                } else {
                    alert('Error: ' + data.error);
                    window.location.reload();
                }
            } catch (err) {
                alert('Connection error');
                window.location.reload();
            }
        }



        function finishGeneration(layout) {
            generatedLayout = layout;
            document.getElementById('loader-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('result-view').classList.add('grid');

            // Find elements if they exist
            const chatVenture = document.getElementById('summary-venture-chat');
            const chatArea = document.getElementById('summary-area-chat');
            if (chatVenture) chatVenture.innerText = layout.venture_type || 'Custom';
            if (chatArea) chatArea.innerText = layout.area || 'Optimal';

            // Display AI Advice
            const adviceText = document.getElementById('ai-advice-text');
            if (layout.conversational_response) {
                adviceText.innerText = layout.conversational_response;
            } else {
                adviceText.innerText = "I've successfully generated your custom architectural layout! You can examine the numbered components in the design and refer to the legend above for details.";
            }

            const svgContainer = document.getElementById('svg-container');
            svgContainer.innerHTML = '';

            // Handle multiple floors
            if (layout.floors && layout.floors.length > 0) {
                // Create floor selector for preview
                const selectorDiv = document.createElement('div');
                selectorDiv.className = 'flex flex-wrap gap-2 mb-6 w-full justify-center';

                layout.floors.forEach((floor, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `px-6 py-2 rounded-xl text-xs font-bold transition-all ${idx === 0 ? 'bg-violet-600 text-white shadow-lg shadow-violet-600/20' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200'}`;
                    btn.innerText = floor.floor_name;
                    btn.onclick = () => {
                        // Update buttons
                        selectorDiv.querySelectorAll('button').forEach(b => {
                            b.className = 'px-6 py-2 rounded-xl text-xs font-bold transition-all bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200';
                        });
                        btn.className = 'px-6 py-2 rounded-xl text-xs font-bold transition-all bg-violet-600 text-white shadow-lg shadow-violet-600/20';

                        // Update SVG
                        renderSvg(floor.svg);
                    };
                    selectorDiv.appendChild(btn);
                });

                // Add selector before SVG
                svgContainer.parentElement.insertBefore(selectorDiv, svgContainer);
                renderSvg(layout.floors[0].svg);
            } else {
                renderSvg(layout.svg);
                updateLegend(layout.rooms);
            }

            function updateLegend(rooms) {
                const container = document.getElementById('legend-container');
                const list = document.getElementById('legend-list');
                if (!rooms || rooms.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                container.classList.remove('hidden');
                list.innerHTML = '';
                rooms.forEach(room => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center gap-2 text-[11px] font-bold text-slate-600 dark:text-slate-400';
                    item.innerHTML = `
                        <span class="w-5 h-5 rounded-full bg-violet-600 text-white flex items-center justify-center text-[9px]">${room.id}</span>
                        <span>${room.name}</span>
                        <span class="text-slate-400 text-[9px] ml-1 font-medium">${room.size}</span>
                    `;
                    list.appendChild(item);
                });
            }

            function renderSvg(svgCode) {
                const innerContainer = document.getElementById('svg-inner-container');
                if (innerContainer) {
                    innerContainer.innerHTML = svgCode;
                    // Reset scaling or fixed sizes if necessary to allow scrolling
                    const svgElement = innerContainer.querySelector('svg');
                    if (svgElement) {
                        // If SVG has fixed width/height, we might want to keep it or adjust it
                        // For now, let it be its natural size to allow scrolling in the parent
                    }
                } else {
                    svgContainer.innerHTML = svgCode;
                }
                document.querySelectorAll('#svg-container svg text').forEach(t => t.style.fontFamily = 'Outfit');
            }
        }

        function openSaveModal() {
            if (!generatedLayout) return;
            document.getElementById('save-modal').classList.remove('hidden');
            document.getElementById('project-name-input').focus();
        }

        function closeSaveModal() {
            document.getElementById('save-modal').classList.add('hidden');
        }

        async function confirmSave() {
            const nameInput = document.getElementById('project-name-input');
            const name = nameInput ? nameInput.value.trim() : "";
            if (!name) { showToast('Please enter a project name.', 'bi-exclamation-triangle-fill'); return; }

            if (!generatedLayout) {
                showToast('No layout data to save.', 'bi-x-circle-fill');
                return;
            }

            const uniqueCode = 'DL-' + Math.random().toString(36).substring(2, 7).toUpperCase();
            generatedLayout.title = name;
            generatedLayout.design_code = uniqueCode;

            const saveBtn = document.getElementById('modal-save-confirm-btn');
            if (saveBtn) {
                saveBtn.innerText = 'Syncing...';
                saveBtn.disabled = true;
            }

            try {
                const response = await fetch('/api/save-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ layout: generatedLayout })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`Saved! Code: ${uniqueCode}`, 'bi-check-circle-fill');
                    setTimeout(() => { window.location.href = '/dashboard'; }, 1200);
                } else {
                    showToast('Save failed: ' + data.error, 'bi-x-circle-fill');
                    if (saveBtn) {
                        saveBtn.innerText = 'Save Project';
                        saveBtn.disabled = false;
                    }
                }
            } catch (err) {
                showToast('Connection error during save', 'bi-x-circle-fill');
                if (saveBtn) {
                    saveBtn.innerText = 'Save Project';
                    saveBtn.disabled = false;
                }
            }
        }

        async function exportPng() {
            if (!generatedLayout) return;
            const projectName = generatedLayout.title || 'dreamlayout';

            if (generatedLayout.floors && generatedLayout.floors.length > 0) {
                for (const floor of generatedLayout.floors) {
                    const fileName = `${projectName}_${floor.floor_name.replace(/\s+/g, '_')}.png`;
                    await triggerPngDownload(floor.svg, fileName);
                }
                showToast(`Exported ${generatedLayout.floors.length} floor images!`, 'bi-download');
            } else {
                const svgContent = generatedLayout.svg || document.getElementById('svg-inner-container').innerHTML;
                await triggerPngDownload(svgContent, `${projectName}_design.png`);
                showToast('PNG Exported!', 'bi-download');
            }
        }

        function triggerPngDownload(svgContent, filename) {
            return new Promise((resolve) => {
                // Ensure SVG has proper attributes for rendering
                if (!svgContent.includes('xmlns=')) {
                    svgContent = svgContent.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                // Get explicit dimensions or defaults
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = svgContent;
                const svgEl = tempDiv.querySelector('svg');
                const width = parseInt(svgEl.getAttribute('width')) || 1200;
                const height = parseInt(svgEl.getAttribute('height')) || 800;

                const scale = 2; // High DPI
                canvas.width = width * scale;
                canvas.height = height * scale;

                // Embed styles if needed (optional but recommended for complex SVGs)
                const svgBlob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                img.onload = function () {
                    // Fill background
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.scale(scale, scale);
                    ctx.drawImage(img, 0, 0);

                    try {
                        const pngUrl = canvas.toDataURL('image/png', 1.0);
                        const link = document.createElement('a');
                        link.href = pngUrl;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (e) {
                        console.error('PNG conversion failed:', e);
                        showToast('Export failed. Try copying the screen.', 'bi-x-circle');
                    }

                    URL.revokeObjectURL(url);
                    resolve();
                };
                img.onerror = function () {
                    console.error('Image load error for SVG');
                    showToast('Error processing image.', 'bi-x-circle');
                    resolve();
                };
                img.src = url;
            });
        }

        // Profile Menu Logic
        (function () {
            const wrapper = document.getElementById('profile-menu-wrapper');
            const toggle = document.getElementById('profile-toggle');
            const dropdown = document.getElementById('profile-dropdown');
            if (!wrapper || !toggle || !dropdown) return;

            let leaveTimeout;
            function show() {
                clearTimeout(leaveTimeout);
                dropdown.classList.remove('hidden');
            }
            function hide() { leaveTimeout = setTimeout(() => { dropdown.classList.add('hidden'); }, 300); }

            wrapper.addEventListener('mouseenter', show);
            wrapper.addEventListener('mouseleave', hide);

            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                dropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) dropdown.classList.add('hidden');
            });
        })();

        function toggleChat() {
            const chatCol = document.querySelector('.lg:col-span-4');
            const drawingCol = document.querySelector('.lg:col-span-8');
            const showChatBtn = document.getElementById('open-chat-btn');

            if (chatCol.classList.contains('hidden')) {
                chatCol.classList.remove('hidden');
                drawingCol.classList.replace('lg:col-span-12', 'lg:col-span-8');
                showChatBtn.classList.add('hidden');
            } else {
                chatCol.classList.add('hidden');
                drawingCol.classList.replace('lg:col-span-8', 'lg:col-span-12');
                showChatBtn.classList.remove('hidden');
            }
        }

        function setTheme(theme) {
            const html = document.documentElement;
            const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
            if (theme === 'dark' || (theme === 'system' && darkQuery.matches)) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            localStorage.setItem('theme', theme);
            updateThemeUI(theme);
        }

        function updateThemeUI(theme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-violet-600');
                if (btn.classList.contains(theme)) {
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-violet-600');
                }
            });
        }

        // Mobile Menu Logic
        (function () {
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            const icon = document.getElementById('menu-icon');
            if (!btn || !menu || !icon) return;

            btn.onclick = () => {
                const isHidden = menu.classList.contains('hidden');
                if (isHidden) {
                    menu.classList.remove('hidden');
                    icon.setAttribute('d', 'M6 18L18 6M6 6l12 12');
                } else {
                    menu.classList.add('hidden');
                    icon.setAttribute('d', 'M4 6h16M4 12h16M4 18h16');
                }
            };
        })();

        // Initialize Everything
        document.addEventListener('DOMContentLoaded', () => {
            initCustomSelects();
        });

        function initCustomSelects() {
            document.querySelectorAll('.custom-select-container').forEach(container => {
                const select = container.querySelector('select');
                const trigger = container.querySelector('.custom-select-trigger');
                const triggerText = trigger.querySelector('.selected-value');
                const optionsContainer = container.querySelector('.custom-options');

                // Clear and populate custom options
                optionsContainer.innerHTML = '';
                Array.from(select.options).forEach(opt => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `custom-option ${opt.selected ? 'selected' : ''}`;
                    optionDiv.innerText = opt.text;
                    optionDiv.onclick = () => {
                        select.value = opt.value;
                        triggerText.innerText = opt.text;

                        // Close dropdown
                        container.classList.remove('open');

                        // Update selection visual state
                        optionsContainer.querySelectorAll('.custom-option').forEach(d => d.classList.remove('selected'));
                        optionDiv.classList.add('selected');

                        // Trigger change event for logic like "Other"
                        select.dispatchEvent(new Event('change'));
                    };
                    optionsContainer.appendChild(optionDiv);
                });

                // Toggle logic
                trigger.onclick = (e) => {
                    e.stopPropagation();
                    // Close others
                    document.querySelectorAll('.custom-select-container').forEach(c => {
                        if (c !== container) c.classList.remove('open');
                    });
                    container.classList.toggle('open');
                };
            });

            // Close when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
            });
        }

        function showToast(message, iconClass = 'bi-exclamation-triangle-fill') {
            const toast = document.getElementById('custom-toast');
            if (!toast) {
                const toastEl = document.createElement('div');
                toastEl.id = 'custom-toast';
                toastEl.innerHTML = `
                    <div class="toast-content animate-fade-in-up">
                        <span class="toast-icon flex items-center justify-center text-violet-600"><i class="bi ${iconClass}"></i></span>
                        <span class="toast-message">${message}</span>
                    </div>
                `;
                document.body.appendChild(toastEl);
                setTimeout(() => toastEl.classList.add('show'), 10);
                setTimeout(() => {
                    toastEl.classList.remove('show');
                    setTimeout(() => toastEl.remove(), 500);
                }, 4000);
            }
        }
        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput && chatInput.value.trim()) {
                const msg = chatInput.value.trim();
                const messagesContainer = document.getElementById('chat-messages');

                // User message
                const userMsg = document.createElement('div');
                userMsg.className = 'flex gap-3 flex-row-reverse animate-fade-in-up';
                userMsg.innerHTML = `
                    <div class="w-8 h-8 rounded-lg bg-slate-200 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-400 text-sm shrink-0 font-bold">U</div>
                    <div class="bg-violet-600 text-white p-4 rounded-2xl rounded-tr-none shadow-sm text-sm leading-relaxed font-medium max-w-[80%]">
                        ${msg}
                    </div>
                `;
                messagesContainer.appendChild(userMsg);
                chatInput.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Real AI Chat
                try {
                    const response = await fetch('/api/chat-layout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: msg,
                            layout: generatedLayout
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        const aiMsg = document.createElement('div');
                        aiMsg.className = 'flex gap-3 animate-fade-in-up';
                        aiMsg.innerHTML = `
                            <div class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center text-violet-600 text-sm shrink-0 font-bold">A</div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-100 dark:border-slate-700 shadow-sm text-sm text-slate-700 dark:text-slate-300 leading-relaxed font-medium whitespace-pre-wrap">
                                ${data.response}
                            </div>
                        `;
                        messagesContainer.appendChild(aiMsg);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } catch (err) {
                    console.error('Chat error:', err);
                }
            }
        }

        // Chat Interaction logic
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const chatInput = document.getElementById('chat-input');
                if (chatInput && chatInput === document.activeElement) {
                    sendMessage();
                }
            }
        });
    </script>
</body>

</html>